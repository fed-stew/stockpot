# Stockpot Repository Analysis Report

**Version:** 0.15.0  
**Analysis Date:** Generated by Stockpot ğŸ²

---

## Executive Summary

Stockpot is a **Rust-based AI coding assistant** that provides GUI, CLI, and TUI interfaces for interacting with various LLM providers. It's designed as an open-source alternative to commercial tools like Cursor and Windsurf, built on top of the `serdesAI` framework.

### Key Strengths
- âœ… **Multi-interface architecture** (GUI/CLI/Bridge modes)
- âœ… **Multi-provider support** (OpenAI, Anthropic, Google, Azure, OAuth providers)
- âœ… **Robust agent system** with extensible JSON-defined agents
- âœ… **MCP (Model Context Protocol) integration**
- âœ… **Comprehensive tool system** (file ops, shell, grep, diff)
- âœ… **All 93 tests passing**
- âœ… **Only 2 minor clippy warnings**

### Areas for Improvement
- âš ï¸ **Several files exceed 600-line limit** (needs refactoring)
- âš ï¸ **Known GUI issue**: Text selection not rendering correctly (documented in ISSUE.md)
- âš ï¸ **Some deprecated code** in agent execution

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Stockpot                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Entry Points                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   GUI   â”‚  â”‚   CLI   â”‚  â”‚  Bridge â”‚  â”‚   TUI   â”‚            â”‚
â”‚  â”‚ (GPUI)  â”‚  â”‚ (REPL)  â”‚  â”‚(NDJSON) â”‚  â”‚(planned)â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â”‚            â”‚            â”‚                               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                     â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚           AgentExecutor             â”‚                       â”‚
â”‚  â”‚  (serdesAI-based execution loop)    â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚           MessageBus                â”‚                       â”‚
â”‚  â”‚  (pub/sub event-driven messaging)   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚         â”‚        â”‚        â”‚         â”‚                       â”‚
â”‚  â–¼         â–¼        â–¼        â–¼         â–¼                       â”‚
â”‚ Tools   Agents   Models   MCP      Sessions                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Module Breakdown

### 1. **Agents** (`src/agents/`)
The heart of Stockpot's AI capabilities.

| File | Lines | Purpose |
|------|-------|---------|
| `executor.rs` | **1,721** âš ï¸ | Agent execution with serdesAI integration |
| `manager.rs` | 181 | Agent registry and switching |
| `json_agent.rs` | 337 | JSON-defined custom agents |
| `base.rs` | 30 | SpotAgent trait definition |

**Key Types:**
- `SpotAgent` - Trait for all agents
- `AgentExecutor` - Runs agents with streaming support
- `AgentManager` - Registry for built-in and custom agents
- `AgentCapabilities` - Permission flags (shell, file_write, file_read, etc.)
- `UserMode` - Controls agent visibility (Normal/Expert/Developer)

**Built-in Agents:**
- `stockpot` - Main coding assistant (full capabilities)
- `planning` - Multi-phase project planning
- `explore` - Codebase exploration (read-only)
- `code-reviewer` - Language-agnostic code review

### 2. **Tools** (`src/tools/`)
File operations, shell execution, and agent collaboration.

| File | Lines | Purpose |
|------|-------|---------|
| `registry.rs` | **810** âš ï¸ | serdesAI tool implementations |
| `file_ops.rs` | 580 | list_files, read_file, write_file, grep |
| `diff.rs` | 455 | Unified diff parsing and application |
| `shell.rs` | 120 | Shell command execution |
| `agent_tools.rs` | 251 | invoke_agent, list_agents |

**Available Tools:**
- `list_files` - Directory listing with smart filtering
- `read_file` - File reading with line-range support
- `edit_file` - Multi-mode file editing (content/replacements/delete)
- `delete_file` - File deletion
- `grep` - Pattern search across files
- `run_shell_command` - Shell execution with timeout
- `share_your_reasoning` - Transparency tool
- `invoke_agent` / `list_agents` - Sub-agent collaboration

### 3. **GUI** (`src/gui/`)
GPUI-based graphical interface (using Zed's UI framework).

| File | Lines | Purpose |
|------|-------|---------|
| `app.rs` | **1,764** âš ï¸ | Main application state |
| `app/settings.rs` | **2,726** âš ï¸ | Settings panel (massive!) |
| `state/conversation.rs` | **1,030** âš ï¸ | Chat state management |
| `components/text_input.rs` | 619 âš ï¸ | Custom text input |
| `components/selectable_text.rs` | 326 | Text selection (has issues) |

**Key Components:**
- `ChatApp` - Main application entity
- `Conversation` - Message history and state
- `SelectableText` - Text selection (documented issue)
- Collapsible sections for nested agent output

### 4. **CLI** (`src/cli/`)
Terminal-based interfaces.

| File | Lines | Purpose |
|------|-------|---------|
| `repl.rs` | **1,054** âš ï¸ | Interactive REPL |
| `completion_reedline.rs` | **809** âš ï¸ | Tab completion |
| `bridge.rs` | 543 | NDJSON bridge for external UIs |
| `commands/*.rs` | ~1,500 | Command implementations |

**REPL Commands:**
- `/model`, `/models` - Model management
- `/agent`, `/agents` - Agent switching
- `/save`, `/load`, `/sessions` - Session management
- `/mcp status/start/stop` - MCP server control
- `/context`, `/truncate` - Context management
- `/yolo` - Auto-approve mode

### 5. **Messaging** (`src/messaging/`)
Event-driven architecture for UI decoupling.

| File | Lines | Purpose |
|------|-------|---------|
| `renderer.rs` | 768 âš ï¸ | Terminal markdown rendering |
| `types.rs` | 490 | Message type definitions |
| `event_bridge.rs` | 448 | StreamEvent â†’ Message conversion |
| `spinner.rs` | 204 | Activity indicator |
| `bus.rs` | 78 | Pub/sub message bus |

**Message Types:**
- `TextDelta` - Streaming text content
- `Thinking` - Reasoning/thinking content
- `ToolCall` - Tool invocation events
- `Agent` - Agent lifecycle events

### 6. **Models** (`src/models/`)
LLM provider configuration and management.

| File | Lines | Purpose |
|------|-------|---------|
| `config.rs` | 716 âš ï¸ | Model configuration types |
| `settings.rs` | 341 | Per-model settings |
| `defaults.rs` | 48 | Featured model defaults |

**Supported Providers:**
- OpenAI (GPT-4o, o1, etc.)
- Anthropic (Claude 3.5 Sonnet, etc.)
- Google (Gemini 2.0 Flash, etc.)
- Azure OpenAI
- OpenRouter
- Custom OpenAI/Anthropic-compatible endpoints
- OAuth: ChatGPT Plus, Claude Code

### 7. **MCP** (`src/mcp/`)
Model Context Protocol integration.

| File | Lines | Purpose |
|------|-------|---------|
| `manager.rs` | 335 | Server lifecycle management |
| `config.rs` | 240 | Configuration loading |

### 8. **Other Modules**

| Module | Purpose |
|--------|---------|
| `auth/` | OAuth for ChatGPT and Claude Code |
| `config/` | Settings and XDG directory management |
| `db/` | SQLite for persistence |
| `session/` | Conversation session save/load |
| `tokens.rs` | Token estimation |
| `version_check.rs` | Update checking |

---

## Code Quality Analysis

### Test Coverage
```
test result: ok. 93 passed; 0 failed; 0 ignored
```

All tests passing across:
- Agent system
- Tool implementations
- Session management
- Message rendering
- Model configuration
- Database operations

### Clippy Warnings
Only 2 minor warnings:
1. `manual_clamp` in `throughput_chart.rs` - Use `.clamp()` instead of `.min().max()`
2. `unnecessary_cast` in same file - Redundant `as f32` cast

### Files Exceeding 600-Line Limit âš ï¸

| File | Lines | Recommendation |
|------|-------|----------------|
| `gui/app/settings.rs` | 2,726 | **Critical** - Split into settings modules |
| `gui/app.rs` | 1,764 | Split into app/state, app/rendering, app/handlers |
| `agents/executor.rs` | 1,721 | Extract streaming logic, tool execution |
| `cli/repl.rs` | 1,054 | Extract command handlers |
| `gui/state/conversation.rs` | 1,030 | Split message types, formatting |
| `tools/registry.rs` | 810 | One file per tool category |
| `cli/completion_reedline.rs` | 809 | Extract completion logic by type |
| `messaging/renderer.rs` | 768 | Extract syntax highlighting, markdown |
| `models/config.rs` | 716 | Split registry from config types |
| `gui/components/text_input.rs` | 619 | Extract event handlers |

---

## Known Issues

### 1. Text Selection in GUI (ISSUE.md)
**Status:** Documented, not resolved

**Problem:** Visual selection highlighting doesn't render correctly in chat message bubbles.

**Symptoms:**
- Text renders vertically (one character per line) with custom Element
- Selection state is tracked correctly
- Copy (Cmd+C) works
- Double/triple-click selection works
- **Visual highlight does NOT appear**

**Root Cause:** GPUI's custom Element layout system not properly communicating size constraints.

**Suggested Investigation:**
1. Study Zed's `EditorElement` implementation
2. Use `TextRun` with `background_color` for selection highlighting
3. Add debug logging to understand actual bounds values

---

## Dependencies

### Core Framework
- `serdes-ai` suite - AI agent framework (custom GitHub dependency)
- `gpui` - Zed's GPU-accelerated UI framework
- `gpui-component` - UI component library (forked version)

### CLI/Terminal
- `clap` - Argument parsing
- `reedline` - Line editing
- `crossterm` / `ratatui` - Terminal UI
- `syntect` - Syntax highlighting

### Data
- `rusqlite` - SQLite database
- `serde` / `serde_json` - Serialization
- `chrono` - Date/time handling

### Async
- `tokio` - Async runtime
- `futures` - Async utilities
- `async-trait` - Async trait support

### Platform-Specific
- `mupdf` (Unix only) - PDF processing
- `pty-process` (Unix only) - PTY handling

---

## Recommendations

### High Priority

1. **Refactor `gui/app/settings.rs`** (2,726 lines)
   - Extract into: `settings/general.rs`, `settings/models.rs`, `settings/agents.rs`, `settings/mcp.rs`
   - This is nearly 5x the recommended limit

2. **Refactor `agents/executor.rs`** (1,721 lines)
   - Extract: `executor/streaming.rs`, `executor/tools.rs`, `executor/history.rs`
   - Remove deprecated `execute_agent` function

3. **Fix GUI text selection** (ISSUE.md)
   - Investigate GPUI's text shaping and layout system
   - Consider using `TextRun` with `background_color` approach

### Medium Priority

4. **Refactor `gui/app.rs`** (1,764 lines)
   - Extract: rendering logic, event handlers, state management

5. **Refactor `cli/repl.rs`** (1,054 lines)
   - Move command handling to dedicated modules

6. **Fix clippy warnings**
   - Apply suggested fixes for `manual_clamp` and `unnecessary_cast`

### Low Priority

7. **Add more doc-tests**
   - 13 doc-tests are currently ignored
   - Consider enabling or removing them

8. **Consider TUI implementation**
   - Currently shows "not yet implemented" message
   - Could leverage existing `ratatui` dependency

---

## Conclusion

Stockpot is a well-architected Rust application with a solid foundation. The codebase follows good practices overall, with comprehensive test coverage and minimal linting issues. The main areas needing attention are:

1. **File size discipline** - Several files have grown beyond maintainable limits
2. **GUI text selection** - Known issue affecting user experience
3. **Code organization** - Some modules could benefit from further decomposition

The project demonstrates good separation of concerns with its messaging bus architecture, allowing the same core logic to power GUI, CLI, and bridge modes. The agent system is extensible and well-designed, supporting both built-in and custom JSON-defined agents.

---

*Report generated by Stockpot ğŸ² - Your AI coding companion*
